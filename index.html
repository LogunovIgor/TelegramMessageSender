<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="css/style.css" type="text/css" rel="stylesheet">
    <title>Отправитель сообщений в Telegram</title>
</head>

<body>
    <div class="content">
        <article class="content-body">
            <section class="content-body-item">
                <div class="content-body-item-header">
                    <img class="content-body-item-header-img" src="./img/telegram.png">
                </div>
                <div class="content-body-item-body">
                    <form>
                        <div>
                            <select id="users" class="form-select form-select-lg mb-3"
                                aria-label=".form-select-lg example" onchange="updateUsernameInfo()">
                                <option selected disabled value="0">Select telegram user</option>
                            </select>
                        </div>
                        <div class="input-group mb-2">
                            <div class="input-group-prepend">
                                <div id="userInfoType" class="input-group-text">&nbsp;</div>
                            </div>
                            <input id="userInfoValue" type="text" class="form-control"
                                aria-describedby="inputGroupPrepend3" disabled>
                        </div>
                        <div class="mb-3">
                            <label for="messageText" class="form-label">Текст сообщения:</label>
                            <textarea class="form-control message-area" id="messageText" rows="3" onchange="checkImagesInTextArea()"></textarea>
                        </div>
                        <div id="text-href-block">
                            <img id="text-href-image" src="./img/telegram.png">
                        </div>
                        <div class="content-body-item-body-actions">
                            <button type="button" class="btn btn-primary btn-lg"
                                onclick="sendMessage()">Отправить</button>
                            <button type="reset" class="btn btn-secondary btn-lg" onclick="onClear()">Очистить</button>
                        </div>
                    </form>
                </div>
            </section>
            <div id="content-body-item-result-block">
                <span id="content-body-item-result-text">RESULT</span>
            </div>
        </article>
    </div>
    <script>
        let userList = getUsersData();
        initializeUsersSelector(userList);

        function onClear() {
            document.getElementById('content-body-item-result-block').style.setProperty('display', 'none');
        }

        function checkImagesInTextArea() {
            let messageRows = document.getElementById('messageText').value.split(' ');
            const pattern = /^(https?):\/\/[^\s$.?#].[^\s]*(?:jpg|jpeg|png)$/;
            
            let imageHref;
            for(let i = 0; i < messageRows.length; i++) {
                if (pattern.test(messageRows[i])) {
                    imageHref = messageRows[i];
                    document.getElementById('text-href-block').style.setProperty('display', 'flex');
                    document.getElementById('text-href-image').src = imageHref;
                    document.getElementById('messageText').value = document.getElementById('messageText').value.replace(imageHref, '');

                    break;
                }
            }
        }

        function sendMessage() {
            let selectNode = document.getElementById('users');
            let selectNodeUserId = selectNode.value;

            if (selectNodeUserId == 0) {
                document.getElementById('content-body-item-result-block').style.setProperty('display', 'block');
                document.getElementById('content-body-item-result-text').innerHTML = 'Необходимо выбрать пользователя.';
                document.getElementById('content-body-item-result-text').style.setProperty('color', 'red');
                return;
            }

            let messageNode = document.getElementById('messageText');
            let message = messageNode.value;

            if (message == null || message.length == 0) {
                document.getElementById('content-body-item-result-block').style.setProperty('display', 'block');
                document.getElementById('content-body-item-result-text').innerHTML = 'Введите сообщение для отправки.';
                document.getElementById('content-body-item-result-text').style.setProperty('color', 'red');
                return;
            }

            let imageHref = document.getElementById('text-href-image').src;
            send(selectNodeUserId, message, imageHref);
            document.getElementById('content-body-item-result-block').style.setProperty('display', 'block');
            document.getElementById('content-body-item-result-text').innerHTML = 'Сообщение успешно отправлено.';
            document.getElementById('content-body-item-result-text').style.setProperty('color', 'green');
            messageNode.value = '';
        }

        function send(id, text, imageHref) {
            let url = "https://api.telegram.org/bot6234049622:AAEQ1JqgeIlvCzAItBvZ65F5iLB0h2ZCLMU/sendPhoto?chat_id=" + id + "&photo=" + imageHref + "&caption=" + text;

            if (imageHref == null || imageHref == undefined)
                url = "https://api.telegram.org/bot6234049622:AAEQ1JqgeIlvCzAItBvZ65F5iLB0h2ZCLMU/sendMessage?chat_id=" + id + "&text=" + text;

            let request = new XMLHttpRequest();
            request.open('GET', url, true);
            request.send();
        }

        function updateUsernameInfo() {
            let selectNode = document.getElementById('users');
            let selectNodeUserId = selectNode.value;

            if (selectNodeUserId == null || selectNodeUserId == undefined)
                return;

            var currentUser = userList.find(usr => usr.id == selectNodeUserId);

            if (currentUser == null || currentUser == undefined || currentUser.username == null || currentUser.username == undefined) {
                document.getElementById('userInfoType').innerHTML = 'ID';
                document.getElementById('userInfoValue').value = selectNodeUserId;
                return;
            }

            document.getElementById('userInfoType').innerHTML = '@';
            document.getElementById('userInfoValue').value = currentUser.username + ` (${currentUser.id})`;
        }

        function getUsersData() {
            let ids = [388042434, 223054377, 232729325, 5062901177, 5677540667, 6081746371, 596300784];
            let users = [];

            for (let i = 0; i < ids.length; i++) {
                let request = new XMLHttpRequest();
                let url = "https://api.telegram.org/bot6234049622:AAEQ1JqgeIlvCzAItBvZ65F5iLB0h2ZCLMU/getChatMember?chat_id=" + ids[i] + "&user_id=" + ids[i];

                request.open('GET', url, false);
                request.send();

                var data = JSON.parse(request.responseText);

                if (data != null && data.ok) {
                    let user = {
                        id: ids[i],
                        firstName: data.result.user.first_name,
                        lastName: data.result.user.last_name,
                        username: data.result.user.username
                    }

                    users.push(user);
                }
            }

            return users;
        }

        function initializeUsersSelector(usrs) {
            for (let i = 0; i < usrs.length; i++) {
                let userName = (usrs[i].firstName ?? '') + ' ' + (usrs[i].lastName ?? '');
                document.getElementById('users').innerHTML += `<option value="${usrs[i].id}">${userName.trim()}</options>`;
            }
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
</body>

</html>